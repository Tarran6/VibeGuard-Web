<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>VibeGuard Auth</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #0d0d1a; color: #e8e8f0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; padding: 20px; text-align: center; }
    .card { background: #16162a; border: 1px solid #2a2a4a; border-radius: 20px; padding: 24px; width: 100%; max-width: 320px; }
    .btn { display: block; width: 100%; padding: 16px; margin: 12px 0; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; text-decoration: none; font-size: 15px; }
    .btn-metamask { background: #f6851b; color: white; }
    .btn-trust { background: #3375bb; color: white; }
    .btn-internal { background: #7c5cfc; color: white; }
    .muted { color: #8888aa; font-size: 13px; margin-top: 20px; }
    #status { display: none; margin-top: 20px; font-weight: bold; color: #4fc3f7; }
  </style>
</head>
<body>

  <div class="card">
    <h2 style="margin-top:0">üõ°Ô∏è VibeGuard</h2>
    <p class="muted">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤–∞—à–µ–≥–æ –∫–æ—à–µ–ª—å–∫–∞, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –µ–≥–æ –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–¥–ø–∏—Å—å.</p>

    <a id="mmLink" class="btn btn-metamask" href="#">–û—Ç–∫—Ä—ã—Ç—å MetaMask</a>
    <a id="twLink" class="btn btn-trust" href="#">–û—Ç–∫—Ä—ã—Ç—å Trust Wallet</a>

    <div style="margin: 20px 0; height: 1px; background: #2a2a4a;"></div>

    <button class="btn btn-internal" onclick="connect()">–Ø —É–∂–µ –≤–Ω—É—Ç—Ä–∏ –∫–æ—à–µ–ª—å–∫–∞</button>
    
    <div id="status">–û–±—Ä–∞–±–æ—Ç–∫–∞...</div>
  </div>

  <p class="muted">–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è Web3 –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</p>

<script>
  const tg = window.Telegram.WebApp;
  const NONCE = new URLSearchParams(window.location.search).get("nonce") || "";
  const domain = window.location.host + window.location.pathname;

  // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫–∏ —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  document.getElementById('mmLink').href = "https://metamask.app.link/dapp/" + domain + "?nonce=" + NONCE;
  document.getElementById('twLink').href = "https://link.trustwallet.com/open_url?url=" + encodeURIComponent(window.location.href);

  tg.expand();

  async function connect() {
    if (typeof window.ethereum === 'undefined') {
      alert("–ö–æ—à–µ–ª–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–û—Ç–∫—Ä—ã—Ç—å –∫–æ—à–µ–ª–µ–∫' –≤—ã—à–µ.");
      return;
    }

    const status = document.getElementById('status');
    status.style.display = 'block';

    try {
      const provider = new ethers.BrowserProvider(window.ethereum);
      const accounts = await provider.send("eth_requestAccounts", []);
      const signer = await provider.getSigner();
      const signature = await signer.signMessage("VibeGuard verification: " + NONCE);

      tg.sendData(JSON.stringify({ address: accounts[0], signature }));
      status.textContent = "‚úÖ –ì–æ—Ç–æ–≤–æ! –ó–∞–∫—Ä—ã–≤–∞–µ–º...";
      setTimeout(() => tg.close(), 1000);
    } catch (e) {
      alert("–û—à–∏–±–∫–∞: " + e.message);
      status.style.display = 'none';
    }
  }
</script>
</body>
</html>
